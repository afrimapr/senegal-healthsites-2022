---
title: "Comparing health facility location data available for Saint Louis, Senegal"
#output: html_document
author: "Andy South @afrimapr, Mark Herringer @sharehealthdata, Lamine Ndiaye @lamineyasey"
date: "DRAFT `r Sys.Date()`"
output: pdf_document
urlcolor: blue
always_allow_html: true
---

This is a data-driven document [open-source code here](https://github.com/afrimapr/senegal-healthsites-2022/blob/master/senegal-healthsites-compare.Rmd)   

Funded by COVIDaction Vaccine Data Co-Lab - [Healthsites.io](https://healthsites.io/) Emergency health data validation.

Initial comparison of data provided by COUS [Centre des Opérations d'Urgence Sanitaire](https://www.sante.gouv.sn/les-services-rattaches/le-centre-des-op%C3%A9rations-durgence-sanitaire-cous) & DPRS [Direction de la Planification, de la Recherche et des Statistiques](https://www.sante.gouv.sn/les-directions/la-direction-de-la-planification-de-la-recherche-et-des-statistiques-0) for Saint Louis with OSM Senegal survey conducted in February 2022.


#### Summary 

The aim is to see if we can develop re-useable code to help with the process of improving health facility location data by comparing and combining data from different sources.

Prior to an in person workshop COUS and DPRS provided data.

**COUS** provided data for 9 facilities in Saint Louis in a table with **9 rows** and **130 columns** including coordinates and attributes such as the numbers of beds and staff.

**DPRS** provided the names of facilities and regions for Saint Louis in a file with **374 rows and 1 column**. Due to the format of the data, it is not straightforward automatically to compare these with the COUS data.

**OSM Senegal** surveyed facilities in person in Saint Louis, providing a file with **394 rows** and recording attribute data in **289 columns**.

source      | num facilities | columns of info | coords? 
----------- | ------ | ----- | ------------ | -----------
1. COUS     |  9 | 130 | coords  
3. DPRS | <374 | 1 | no 
2. OSM-Senegal survey    | 394 | 289 | coords 

**Agreement on a strict naming convention for facilities would make it much easier to compare and combine these data.**


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)

library(knitr)
library(tidyverse)
library(sf)
library(tmap)

```


```{r read-data, include=FALSE}

# get local file data, can't share yet
folder <- "C:\\Users\\andy.south\\Google Drive\\afrimapr-gdrive\\Proposals\\2022-01-senegal-covidaction\\data\\"
filename <- "2022-02-senegal-structures.csv"
filename <- paste0(folder,filename)

filenamecous_sl <- "2022-02-20-cous10-stlouis-anon.csv"
filenamecous_sl <- paste0(folder,filenamecous_sl)

filename_lamine <- "2022-02-28-lamine-kobo.csv"
filename_lamine <- paste0(folder,filename_lamine)
  
#dprs file just contains names of facilities - with names of admin regions in too
filename_dprs <- "2022-02-dprs-names.csv"
filename_dprs <- paste0(folder,filename_dprs)

filename_districts <- "2022-02-senegal-health-districts.csv"
filename_districts <- paste0(folder,filename_districts)

dfdistricts <- read_csv(filename_districts, locale=locale(encoding = "ISO-8859-1"))
#remove last row which contains NA & breaks sf conversion later
dfdistricts <- filter(dfdistricts,!is.na(Polygones))

names(dfdistricts)
#[1] "Région Médicale"   "District de Santé" "Polygones" 
#get rid of accents, lowercase & replace spaces

names(dfdistricts) <- names(dfdistricts) %>% 
  #remove accents
  stringi::stri_trans_general("Latin-ASCII") %>%
  #lower case
  str_to_lower() %>% 
  #replace spaces with _
  str_replace_all("\\s", "_")


#no header in the dprs file
dfdprs <- read_csv(filename_dprs, col_names = "dprs_names")

dfcous_sl <- read_csv(filenamecous_sl)
#names(dfcous_sl) #127!

#the Longitude of #9 needed to be -ve to stop it being in Chad
#I corrected in the csv
#dfcous_sl$Longitude[9]
#[1] -16.1452

dfcous_sl <- dfcous_sl %>% 
  rename(nom = `Quel est le nom de la structure de sante?`) %>% 
  rename(categorie = `Quelle est la Categorie de la Structure de Sante?`)   
  
  #some of conversions below can be done this way too
  #rename_with( str_to_lower() )

# convert cous column names to be more manageable
names(dfcous_sl) <- names(dfcous_sl) %>% 
  #fix accents
  #str_conv(encoding = "ISO-8859-1") %>% 
  #remove accents
  stringi::stri_trans_general("Latin-ASCII") %>%
  #remove some long text
  str_replace_all("Quel est le nombre de ","") %>%
  str_replace_all("Quel est le nombre d'","") %>%
  str_replace_all("Quel est le nombre d ","") %>%
  str_replace_all("Quel est le ","") %>% 
  str_replace_all(" de la structure de sante","") %>% 
  str_replace_all("Quelle est la ","") %>% 
  str_replace_all("\\?", "") %>% 
  str_replace_all(" \\?", "") %>%  
  #lower case
  str_to_lower() %>%
  str_squish() %>% #remove whitespace from either side & repeats in middle
  #replace spaces with _
  str_replace_all("\\s", "_")


```


## COUS data

COUS provided an Excel file with two sheets.

**COUS** Sheet2 for Saint Louis has nine facilities **9 rows** and **130 columns** including coordinates and attributes such as the numbers of beds and staff.

Names of facilities.

```{r cous-names}

dfcousnames <- tibble(cous_names=dfcous_sl$nom)

knitr::kable(dfcousnames)


# EPS1 de Richard Toll
# 3 Centre  de Sante  de Dagana
# Centre de Sante de Saint Louis
# Centre de Sante Amadou Malick Gaye
# Centre de Sante de  Pete
# Centre de santé de Richard Toll
# HOPITAL REGIONAL DE SAINT LOUIS
# CHR NDioum
# Centre de santé de Ross Bethio

#lets add dprs names in half by hand, text searched in RStudio

dfcousnames$dprs_names <- c("EPS 1 Richard Toll",
                             "CS Dagana",
                             "CS Saint - Louis",
                             "?",
                             "[-] CS Pete",
                             "CS Richard Toll",
                             "EPS2 de Saint Louis",
                             "?Antenne de Ndioum",
                             "[-] CS Ross Bethio")
  


```
## DPRS data

DPRS provided the names of facilities and regions for the whole country in a file with **374 rows and 1 column**.

Looking at the first 9 rows of the DPRS data.

```{r dprs-names}

knitr::kable(dfdprs[1:9,])

```
We can see that sometimes rows indicate regions, e.g. `[-] RM Saint-Louis` and `[-] Dagana`. Also sometimes a row with a `[-]` indicates a facility that has control over others e.g. `[-] PS Bokhol`. This makes it difficult to analyse the data automatically because it is difficult to detect whether a row refers to a facility or not. It may be that if a row has a [-] and does not have PS, CS or Case then it is not a facility.

We can compare the COUS & DPRS tables above to check whether the facility names in the COUS data appear exactly the same as in the DPRS data. We would need to be able to write code to find matching names to be able to write a reproducible pipeline for comparing data.

An initial search by eye shows the mismatches between naming in the two datasets. There is at least one facility in the COUS data that seems not present in the DPRS list (Centre de Sante Amadou Malick Gaye).

```{r cous-dprs-names}

knitr::kable(dfcousnames)

```



\pagebreak

### Categories of COUS health facilities Saint Louis

The coordinates provided in the COUS data allow these to be plotted on maps. (Note that one coordinate was missing a negative sign that incorrectly placed it in Chad, it was corrected for the maps here). 

```{r make-geo, include=FALSE}

sfcous_sl <- st_as_sf(dfcous_sl, 
                      coords=c("longitude", "latitude"), 
                      crs=4326)

```

```{r map-cous-sl, eval=TRUE, fig.height=4.5, fig.width=7.5, fig.show='hold'}

library(tmap)
library(afriadmin)

sfsen_adm0 <- afriadmin('senegal',level=0, plot=FALSE)
sfsen_adm1 <- afriadmin('senegal',level=1, plot=FALSE)

#mapping 3 category types
tmap::tm_shape(filter(sfsen_adm1, shapeName=="Saint Louis")) +
    tm_borders("grey", lwd = .5) +
    tm_shape(sfsen_adm0) +
    tm_borders("black", lwd = .5) +
  
  tm_shape(sfcous_sl) +
    #tm_dots(shape=3, size = 0.15, col='red', border.lwd = 0.2) +
  
    tm_symbols(shape="categorie", col='red', shapes=c(3,1,0)) +
  
    tm_layout(main.title='COUS health facilities Saint Louis 2022', main.title.size=1,
              legend.bg.color=TRUE,
              title="map by @afrimapr", title.color="darkgrey", title.size=0.8, title.position=c("RIGHT","BOTTOM")) #main.title goes above map
   
#add NA points, have to do separately because shapeNA doesn't work for size    
# tm_shape(sfsen_sur[is.na(sfsen_sur$beds),]) +
#   tm_dots(shape=3, size = 0.15, col='grey', border.lwd = 0.2) +    
# tm_shape(sfsen_sur) +
#     tm_symbols(col = "building", alpha=0.8, size = "beds", size.max=420, 
#                scale=3, sizes.legend=c(10,100,400), title.col="") +
# tm_add_legend(type="symbol", shape=3, labels = "no bed data", size = 0.5, border.lwd = 0.5, col = "grey") +
#     tm_scale_bar(breaks=c(0,50,100), position=c("LEFT", "BOTTOM")) +


```


### Numbers of beds (lits) in different wards from COUS data

```{r map-cous-lits, eval=TRUE, fig.height=2.5, fig.show='hold'}

lits_columns <- names(sfcous_sl)[str_starts(names(sfcous_sl),"lits")]

for(column_to_map in lits_columns)
{

 #cat(column_to_map)
  
 # tmap::tm_shape(filter(sfsen_adm1, shapeName=="Saint Louis")) +
 #    tm_borders("grey", lwd = .5) +
 #    tm_shape(sfsen_adm0) +
 #    tm_borders("black", lwd = .5) +
 #  
 #  tm_shape(sfcous_sl) +
 #    #tm_dots(shape=3, size = 0.15, col='red', border.lwd = 0.2) +
 #    tm_text(column_to_map, col='red') +
 #    #tm_symbols(shape="categorie", col='red', shapes=c(3,1,0)) +
 #  
 #    tm_layout(main.title=column_to_map, main.title.size=1,
 #              legend.bg.color=TRUE,
 #              title="map by @afrimapr", title.color="darkgrey", title.size=0.8, title.position=c("RIGHT","BOTTOM")) #main.title goes above map
 
# can I do in ggplot to allow repel of labels ? 
library(ggplot2)
library(ggrepel)

gg <- ggplot(filter(sfsen_adm1, shapeName=="Saint Louis")) +
    geom_sf() +
    theme_void() + 
    geom_sf(data=sfcous_sl) +
    geom_text_repel(data=sfcous_sl, aes(label=.data[[column_to_map]], geometry=geometry),
                     stat="sf_coordinates",
                     #point.padding = NA, #allows points to overlap centroid
                     colour='red', size=5
                    ) +
    labs(title = paste("COUS", column_to_map))
    
  
# gg <- ggplot(africountries) +
#     geom_sf(aes(fill = pop_est)) +
#     scale_fill_viridis_c() +
#     theme_void() +
#     geom_text_repel(aes(label=name_long, geometry=geometry),
#                     stat="sf_coordinates",
#                     point.padding = NA, #allows points to overlap centroid
#                     colour='darkgrey', size=3
#                    ) +
#     labs(title = "Population by country 2000", fill = "Population Estimate")

plot(gg)

}

```



## OSM-Senegal survey

OSM-Senegal surveyed facilities in person in Saint Louis in February 2022, providing a file with 394 rows and recording attribute data in 289 columns. Here are some maps summarising the facilities surveyed.


```{r read-data-osm, include=FALSE}

# get local file data, can't share yet
folder <- "C:\\Users\\andy.south\\Google Drive\\afrimapr-gdrive\\Proposals\\2022-01-senegal-covidaction\\data\\"

filename_lamine <- "2022-02-28-lamine-kobo.csv"
filename_lamine <- paste0(folder,filename_lamine)


#dfosm <- read_csv(filename_lamine)
#394 rows 289 columns
#sorts accents
dfosm <- read_csv(filename_lamine, locale=locale(encoding = "ISO-8859-1"))

#convert column names to lowercase & remove any accents and spaces
names(dfosm) <- names(dfosm) %>% 
  #fix accents
  str_conv(encoding = "ISO-8859-1") %>% 
  #remove accents
  stringi::stri_trans_general("Latin-ASCII") %>%
  #lower case
  str_to_lower() %>% 
  #replace spaces with _
  str_replace_all("\\s", "_") %>% 
  #remove _facility_location_ before coords
  str_replace_all("_facility_location_", "") %>% 
  str_replace_all("\\?", "") %>%   
  str_replace_all("what_is_the_number_of_", "") 

#dfosm$in_which_health_zone_is_the_facility_located
#[1] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA 

dfosm2 <- dfosm %>% select(name_of_facility, 
                           city, 
                           operator_type, 
                           longitude, 
                           latitude, 
                           operational_status,
                           facility_category,
                           number_of_beds,
                           number_of_doctors,
                           number_of_nurses)

table(dfosm2$facility_category)
# Clinic  Dentist  Doctors Hospital Pharmacy 
# 15        2      294       22       61 


```

```{r make-geo-osm, include=FALSE}

sfosm <- st_as_sf(dfosm2, 
                  coords=c("longitude", "latitude"), 
                  crs=4326)


```


### Categories of facilities in OSM-Senegal survey

Senegal health facility levels are converted into OSM categories of Hospital, Clinic, Doctor as follows :

Senegal level | Senegal type | Senegal abbreviation | OSM category
------: | ------------ | ----- | -----  
1            | Hopital    | HP | Hospital 
1            | Etablissement public de Santé 1 (départementale)| EPS 1 | Hospital
1            | Etablissement public de Santé 2 (régionale)| EPS 2 | Hospital
1            | Etablissement public de Santé 3 (nationale) | EPS 3 | Hospital
2            | Centre de Santé    | CS | Clinic 
2            | District de Sanitaire    | DS | Clinic 
3            | Poste de Santé | PS | Doctors 
3            | Case de Santé | ?CS | Doctors 

```{r map-osm-sl, eval=TRUE, fig.height=4}

#, fig.show='hold'

library(tmap)
library(afriadmin)

sfsen_adm0 <- afriadmin('senegal',level=0, plot=FALSE)
sfsen_adm1 <- afriadmin('senegal',level=1, plot=FALSE)

#map category types
tmap::tm_shape(filter(sfsen_adm1, shapeName=="Saint Louis")) +
    tm_borders("grey", lwd = .5) +
    tm_shape(sfsen_adm0) +
    tm_borders("black", lwd = .5) +
  
  tm_shape(sfosm) +
    #tm_dots(shape=3, size = 0.15, col='red', border.lwd = 0.2) +
  
  # Clinic  Dentist  Doctors Hospital Pharmacy 
  # 15        2      294       22       61
  #0square,1circle,2triangle,3+,4x
  
    tm_symbols(shape="facility_category", col='red', shapes=c(0,1,3,2,4), size=0.1) +
  
    tm_layout(main.title='OSM-Senegal survey 2022 facility category', main.title.size=1,
              legend.bg.color=TRUE, legend.position=c("center","BOTTOM"),
              title="map by @afrimapr", title.color="darkgrey", title.size=0.8, title.position=c("RIGHT","BOTTOM")) #main.title goes above map
   
#map operator_type
tmap::tm_shape(filter(sfsen_adm1, shapeName=="Saint Louis")) +
    tm_borders("grey", lwd = .5) +
    tm_shape(sfsen_adm0) +
    tm_borders("black", lwd = .5) +
  
  tm_shape(sfosm) +
  
  # table(dfosm$operator_type)
  #Community Government    Private     Public  Religious 
  #      29          2         74        261          1 
  #0square,1circle,2triangle,3+,4x
  
    tm_symbols(shape="operator_type", col='red', shapes=c(0,1,2,3,4), size=0.1) +
  
    tm_layout(main.title='OSM-Senegal survey 2022 operator type', main.title.size=1,
              legend.bg.color=TRUE, legend.position=c("center","BOTTOM"),
              title="map by @afrimapr", title.color="darkgrey", title.size=0.8, title.position=c("RIGHT","BOTTOM")) #main.title goes above map

#add NA points, have to do separately because shapeNA doesn't work for size    
# tm_shape(sfsen_sur[is.na(sfsen_sur$beds),]) +
#   tm_dots(shape=3, size = 0.15, col='grey', border.lwd = 0.2) +    
# tm_shape(sfsen_sur) +
#     tm_symbols(col = "building", alpha=0.8, size = "beds", size.max=420, 
#                scale=3, sizes.legend=c(10,100,400), title.col="") +
# tm_add_legend(type="symbol", shape=3, labels = "no bed data", size = 0.5, border.lwd = 0.5, col = "grey") +
#     tm_scale_bar(breaks=c(0,50,100), position=c("LEFT", "BOTTOM")) +


```

### Numbers of beds, doctors and nurses from OSM-Senegal survey

```{r map-osm-attributes, eval=TRUE, fig.height=4, fig.show='hold'}

columns <- c("number_of_beds","number_of_doctors","number_of_nurses")

for(column_to_map in columns)
{

 #cat(column_to_map)
 
# can I do in ggplot to allow repel of labels ? 
library(ggplot2)
library(ggrepel)

gg <- ggplot(filter(sfsen_adm1, shapeName=="Saint Louis")) +
    geom_sf() +
    theme_void() + 
    geom_sf(data=sfosm, size=0.3) +
    geom_text_repel(data=sfosm, aes(label=.data[[column_to_map]], geometry=geometry),
                     stat="sf_coordinates",
                     #padding default is 0.25
                     box.padding = 0.1,
                     #force=0.5,
                     segment.size = 0.1, segment.alpha = 0.7,
                     #point.padding = NA, #allows points to overlap centroid
                     colour='red', size=1.9
                    ) +
    labs(title = paste("OSM", column_to_map))
    
  
# gg <- ggplot(africountries) +
#     geom_sf(aes(fill = pop_est)) +
#     scale_fill_viridis_c() +
#     theme_void() +
#     geom_text_repel(aes(label=name_long, geometry=geometry),
#                     stat="sf_coordinates",
#                     point.padding = NA, #allows points to overlap centroid
#                     colour='darkgrey', size=3
#                    ) +
#     labs(title = "Population by country 2000", fill = "Population Estimate")

plot(gg)

}

```

```{r map-cous-osm-lits, eval=FALSE, fig.height=2.5, fig.show='hold'}

#eval=FALSE because not very informative
#would be better just to do a table for Cous vs OSM survey

### Compare COUS & OSM-SURVEY bed data

# add the osm num beds to the plot
# labels and points too
# dfosm2$number_of_beds

  
column_to_map <- "lits_en_medecine_"
column_to_map_osm <- "number_of_beds"

gg <- ggplot(filter(sfsen_adm1, shapeName=="Saint Louis")) +
    geom_sf() +
    theme_void() + 
    geom_sf(data=sfcous_sl) +
    geom_text_repel(data=sfcous_sl, aes(label=.data[[column_to_map]], geometry=geometry),
                     stat="sf_coordinates",
                     #point.padding = NA, #allows points to overlap centroid
                     colour='darkgreen', size=4
                    ) +
    geom_sf(data=sfosm, size=0.1) +
    geom_text_repel(data=sfosm, aes(label=.data[[column_to_map_osm]], geometry=geometry),
                     stat="sf_coordinates",
                     #padding default is 0.25
                     box.padding = 0.1,
                     #force=0.5,
                     segment.size = 0.1, segment.alpha = 0.7,
                     #point.padding = NA, #allows points to overlap centroid
                     colour='red', size=1.9
                    ) +
  
    labs(title = paste("COUS", column_to_map))
    

plot(gg)

```
